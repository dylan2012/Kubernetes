# kubernetesä¹‹kubeadmå®‰è£…1.24.+ç‰ˆæœ¬

## ä¸€ã€åŸºç¡€ç¯å¢ƒå‡†å¤‡

é›†ç¾¤è§„åˆ’ä¿¡æ¯ï¼š
|  ä¸»æœºåç§°   | IPåœ°å€  | è¯´æ˜  |
|  ----  | ----  | ----  |
|master01 | 10.199.10.231 | masterèŠ‚ç‚¹
|master02 | 10.199.10.232 |masterèŠ‚ç‚¹
|master03 | 10.199.10.233 |masterèŠ‚ç‚¹
|node01 |10.199.10.234 |nodeèŠ‚ç‚¹
|node02 |10.199.10.235 |nodeèŠ‚ç‚¹
|master-lb |10.199.10.230:16443 |nginxç»„ä»¶ç›‘å¬åœ°å€

è¯´æ˜ï¼š

masterèŠ‚ç‚¹ä¸º3å°å®ç°é«˜å¯ç”¨ï¼Œå¹¶ä¸”é€šè¿‡nginxè¿›è¡Œä»£ç†masteræµé‡å®ç°é«˜å¯ç”¨ï¼Œmasterä¹Ÿå®‰è£…nodeç»„ä»¶ã€‚
nodeèŠ‚ç‚¹ä¸º2å°
nginxåœ¨æ‰€æœ‰èŠ‚ç‚¹å®‰è£…ï¼Œç›‘å¬127.0.0.1:16443ç«¯å£
ç³»ç»Ÿä½¿ç”¨centos7.X

### 1.1 åŸºç¡€ç¯å¢ƒé…ç½®

#### 1.æ‰€æœ‰èŠ‚ç‚¹é…ç½®hosts

```shell
#æ¯å°ä¸»æœºä¿®æ”¹ä¸»æœºå
hostnamectl set-hostname master01
#ä¿®æ”¹hosts
cat >>/etc/hosts<<EOF
10.199.10.231 master01
10.199.10.232 master02
10.199.10.233 master03
10.199.10.234 node01
10.199.10.235 node02
10.199.10.236 node03
EOF
```

#### 2.æ‰€æœ‰èŠ‚ç‚¹å…³é—­é˜²ç«å¢™ã€selinuxã€dnsmasqã€swap

```shell
#å…³é—­é˜²ç«å¢™
systemctl disable --now firewalld
#å…³é—­dnsmasq
systemctl disable --now dnsmasq
#å…³é—­postfix
systemctl  disable --now postfix
#å…³é—­NetworkManager
systemctl disable --now NetworkManager
#å…³é—­selinux
sed -ri 's/(^SELINUX=).*/\1disabled/' /etc/selinux/config
setenforce 0
#å…³é—­swap
sed -ri 's@(^.*swap *swap.*0 0$)@#\1@' /etc/fstab
swapoff -a
```

#### 3.é…ç½®æ—¶é—´åŒæ­¥

æ–¹æ³•1ï¼šä½¿ç”¨ntpdate

```shell
#å®‰è£…ntpdateï¼Œéœ€é…ç½®yumæº
yum install ntpdate -y
#æ‰§è¡ŒåŒæ­¥ï¼Œå¯ä»¥ä½¿ç”¨è‡ªå·±çš„ntpæœåŠ¡å™¨å¦‚æœæ²¡æœ‰
ntpdate time2.aliyun.com
#å†™å…¥å®šæ—¶ä»»åŠ¡
crontab -e
*/5 * * * * ntpdate time2.aliyun.com
```

æ–¹æ³•2ï¼šä½¿ç”¨chrony(æ¨èä½¿ç”¨)

```shell
#å®‰è£…chrony
yum install chrony -y
#åœ¨å…¶ä¸­ä¸€å°ä¸»æœºé…ç½®ä¸ºæ—¶é—´æœåŠ¡å™¨
cat /etc/chrony.conf
server time2.aliyun.com iburst   #ä»å“ªåŒæ­¥æ—¶é—´
driftfile /var/lib/chrony/drift
makestep 1.0 3
rtcsync
allow 192.168.0.0/16  #å…è®¸çš„ntpå®¢æˆ·ç«¯ç½‘æ®µ
local stratum 10
logdir /var/log/chrony
#é‡å¯æœåŠ¡
systemctl restart chronyd
#é…ç½®å…¶ä»–èŠ‚ç‚¹ä»æœåŠ¡ç«¯è·å–æ—¶é—´è¿›è¡ŒåŒæ­¥
cat /etc/chrony.conf
server 10.199.10.231 iburst
#é‡å¯éªŒè¯
systemctl restart chronyd
chronyc sources -v
^* master01                      3   6    17     5    -10us[ -109us] +/-   28ms  #è¿™æ ·è¡¨ç¤ºæ­£å¸¸
```

#### 4.æ‰€æœ‰èŠ‚ç‚¹ä¿®æ”¹èµ„æºé™åˆ¶

```shell
cat > /etc/security/limits.conf <<EOF
*       soft        core        unlimited
*       hard        core        unlimited
*       soft        nproc       1000000
*       hard        nproc       1000000
*       soft        nofile      1000000
*       hard        nofile      1000000
*       soft        memlock     32000
*       hard        memlock     32000
*       soft        msgqueue    8192000
EOF
```

#### 5.sshè®¤è¯ã€å‡çº§ç³»ç»Ÿä»¥åŠå†…æ ¸

```shell
yum install -y sshpass
ssh-keygen -f /root/.ssh/id_rsa -P ''
export IP="10.199.10.231 10.199.10.232 10.199.10.233 10.199.10.234 10.199.10.235"
export SSHPASS=123456
for HOST in $IP;do
     sshpass -e ssh-copy-id -o StrictHostKeyChecking=no $HOST
done

cat >/etc/sysctl.conf<<EOF
net.ipv4.tcp_keepalive_time=600
net.ipv4.tcp_keepalive_intvl=30
net.ipv4.tcp_keepalive_probes=10
net.ipv6.conf.all.disable_ipv6=1
net.ipv6.conf.default.disable_ipv6=1
net.ipv6.conf.lo.disable_ipv6=1
net.ipv4.neigh.default.gc_stale_time=120
net.ipv4.conf.all.rp_filter=0 
net.ipv4.conf.default.rp_filter=0
net.ipv4.conf.default.arp_announce=2
net.ipv4.conf.lo.arp_announce=2
net.ipv4.conf.all.arp_announce=2
net.ipv4.ip_local_port_range= 45001 65000
net.ipv4.ip_forward=1
net.ipv4.tcp_max_tw_buckets=6000
net.ipv4.tcp_syncookies=1
net.ipv4.tcp_synack_retries=2
net.bridge.bridge-nf-call-ip6tables=1
net.bridge.bridge-nf-call-iptables=1
net.netfilter.nf_conntrack_max=2310720
net.ipv6.neigh.default.gc_thresh1=8192
net.ipv6.neigh.default.gc_thresh2=32768
net.ipv6.neigh.default.gc_thresh3=65536
net.core.netdev_max_backlog=16384 # æ¯CPUç½‘ç»œè®¾å¤‡ç§¯å‹é˜Ÿåˆ—é•¿åº¦
net.core.rmem_max = 16777216 # æ‰€æœ‰åè®®ç±»å‹è¯»å†™çš„ç¼“å­˜åŒºå¤§å°
net.core.wmem_max = 16777216
net.ipv4.tcp_max_syn_backlog = 8096 # ç¬¬ä¸€ä¸ªç§¯å‹é˜Ÿåˆ—é•¿åº¦
net.core.somaxconn = 32768 # ç¬¬äºŒä¸ªç§¯å‹é˜Ÿåˆ—é•¿åº¦
fs.inotify.max_user_instances=8192 # è¡¨ç¤ºæ¯ä¸€ä¸ªreal user IDå¯åˆ›å»ºçš„inotify instatncesçš„æ•°é‡ä¸Šé™ï¼Œé»˜è®¤128.
fs.inotify.max_user_watches=524288 # åŒä¸€ç”¨æˆ·åŒæ—¶å¯ä»¥æ·»åŠ çš„watchæ•°ç›®ï¼Œé»˜è®¤8192ã€‚
fs.file-max=52706963
fs.nr_open=52706963
kernel.pid_max = 4194303
net.bridge.bridge-nf-call-arptables=1
vm.swappiness=0 # ç¦æ­¢ä½¿ç”¨ swap ç©ºé—´ï¼Œåªæœ‰å½“ç³»ç»Ÿ OOM æ—¶æ‰å…è®¸ä½¿ç”¨å®ƒ
vm.overcommit_memory=1 # ä¸æ£€æŸ¥ç‰©ç†å†…å­˜æ˜¯å¦å¤Ÿç”¨
vm.panic_on_oom=0 # å¼€å¯ OOM
vm.max_map_count = 262144
EOF
#åŠ è½½ipvsæ¨¡å—
cat >/etc/modules-load.d/ipvs.conf <<EOF
ip_vs
ip_vs_rr
ip_vs_wrr
ip_vs_sh
nf_conntrack
ip_tables
ip_set
xt_set
ipt_set
ipt_rpfilter
ipt_REJECT
ipip
EOF
systemctl enable --now systemd-modules-load.service
#é‡å¯
reboot
#é‡å¯æœåŠ¡å™¨æ‰§è¡Œæ£€æŸ¥
lsmod | grep -e ip_vs -e nf_conntrack
```

#### 6.å®‰è£…åŸºç¡€è½¯ä»¶

```shell
yum install -y yum-utils device-mapper-persistent-data lvm2 wget net-tools nfs-utils lrzsz gcc gcc-c++ make cmake libxml2-devel openssl-devel curl curl-devel unzip sudo ntp libaio-devel wget vim ncurses-devel autoconf automake zlibdevel python-devel epel-release openssh-server socat ipvsadm conntrack ntpdate telnet git ipvsadm
```

#### 7.ä¼˜åŒ–journaldæ—¥å¿—

```shell
mkdir -p /var/log/journal
mkdir -p /etc/systemd/journald.conf.d
cat >/etc/systemd/journald.conf.d/99-prophet.conf <<EOF
[Journal]
# æŒä¹…åŒ–ä¿å­˜åˆ°ç£ç›˜
Storage=persistent
# å‹ç¼©å†å²æ—¥å¿—
Compress=yes
SyncIntervalSec=5m
RateLimitInterval=30s
RateLimitBurst=1000
# æœ€å¤§å ç”¨ç©ºé—´ 1G
SystemMaxUse=1G
# å•æ—¥å¿—æ–‡ä»¶æœ€å¤§ 10M
SystemMaxFileSize=10M
# æ—¥å¿—ä¿å­˜æ—¶é—´ 2 å‘¨
MaxRetentionSec=2week
# ä¸å°†æ—¥å¿—è½¬å‘åˆ° syslog
ForwardToSyslog=no
EOF
systemctl restart systemd-journald && systemctl enable systemd-journald
```

#### 8.ä¸‹è½½å·¥å…·å‡†å¤‡

1.ä¸‹è½½kubernetes1.24.+çš„äºŒè¿›åˆ¶åŒ…
githubäºŒè¿›åˆ¶åŒ…ä¸‹è½½åœ°å€ï¼šhttps://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.24.md
 
wget https://dl.k8s.io/v1.24.2/kubernetes-server-linux-amd64.tar.gz
 
2.ä¸‹è½½etcdctläºŒè¿›åˆ¶åŒ…
githubäºŒè¿›åˆ¶åŒ…ä¸‹è½½åœ°å€ï¼šhttps://github.com/etcd-io/etcd/releases
 
wget https://github.com/etcd-io/etcd/releases/download/v3.5.4/etcd-v3.5.4-linux-amd64.tar.gz
 
3.docker-ceäºŒè¿›åˆ¶åŒ…ä¸‹è½½åœ°å€
äºŒè¿›åˆ¶åŒ…ä¸‹è½½åœ°å€ï¼šhttps://download.docker.com/linux/static/stable/x86_64/
 
è¿™é‡Œéœ€è¦ä¸‹è½½20.10.+ç‰ˆæœ¬
 
wget https://download.docker.com/linux/static/stable/x86_64/docker-20.10.14.tgz
 
4.containerdäºŒè¿›åˆ¶åŒ…ä¸‹è½½
githubä¸‹è½½åœ°å€ï¼šhttps://github.com/containerd/containerd/releases
 
containerdä¸‹è½½æ—¶ä¸‹è½½å¸¦cniæ’ä»¶çš„äºŒè¿›åˆ¶åŒ…ã€‚
 
wget https://github.com/containerd/containerd/releases/download/v1.6.6/cri-containerd-cni-1.6.6-linux-amd64.tar.gz
 
5.ä¸‹è½½cfssläºŒè¿›åˆ¶åŒ…
githubäºŒè¿›åˆ¶åŒ…ä¸‹è½½åœ°å€ï¼šhttps://github.com/cloudflare/cfssl/releases
 
wget https://github.com/cloudflare/cfssl/releases/download/v1.6.1/cfssl_1.6.1_linux_amd64
wget https://github.com/cloudflare/cfssl/releases/download/v1.6.1/cfssljson_1.6.1_linux_amd64
wget https://github.com/cloudflare/cfssl/releases/download/v1.6.1/cfssl-certinfo_1.6.1_linux_amd64
 
6.cniæ’ä»¶ä¸‹è½½
githubä¸‹è½½åœ°å€ï¼šhttps://github.com/containernetworking/plugins/releases
 
wget https://github.com/containernetworking/plugins/releases/download/v1.1.1/cni-plugins-linux-amd64-v1.1.1.tgz
 
7.crictlå®¢æˆ·ç«¯äºŒè¿›åˆ¶ä¸‹è½½
githubä¸‹è½½ï¼šhttps://github.com/kubernetes-sigs/cri-tools/releases
 
wget https://github.com/kubernetes-sigs/cri-tools/releases/download/v1.24.2/crictl-v1.24.2-linux-amd64.tar.gz

kubernetes1.24.+ç‰ˆæœ¬è¯´æ˜ï¼šhttps://github.com/kubernetes/kubernetes/blob/v1.24.0-alpha.1/CHANGELOG/CHANGELOG-1.24.md

### 1.2 å®‰è£… containerd æœåŠ¡

https://containerd.io/downloads/
https://github.com/kubernetes-sigs/cri-tools/releases

```shell
#æ‰€æœ‰èŠ‚ç‚¹å®‰è£…
yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
yum install containerd -y
systemctl start containerd && systemctl enable containerd
mkdir -p /etc/containerd
containerd config default > /etc/containerd/config.toml
sed -i "s#SystemdCgroup = false#SystemdCgroup = true#g" /etc/containerd/config.toml
systemctl restart containerd

#sed -i "s#k8s.gcr.io#registry.cnhangzhou.aliyuncs.com/google_containers#g" /etc/containerd/config.toml
#sed -i '/containerd.runtimes.runc.options/a\ \ \ \ \ \ \ \ \ \ \ \
#SystemdCgroup = true' /etc/containerd/config.toml

#sed -i "s#https://registry-1.docker.io#https://registry.cnhangzhou.aliyuncs.com#g" /etc/containerd/config.toml
systemctl status containerd
ctr version
runc -version

wget https://github.com/kubernetes-sigs/cri-tools/releases/download/v1.24.2/crictl-v1.24.2-linux-amd64.tar.gz
tar -zxvf crictl*.tar.gz -C /usr/local/bin
cat > /etc/crictl.yaml <<EOF
runtime-endpoint: unix:///run/containerd/containerd.sock
EOF
#crictl config runtime-endpoint unix:///var/run/containerd/containerd.sock
```

### 1.3 å®‰è£…ETCD æœåŠ¡

#### å…³äºç­¾åè¯ä¹¦

```shell
wget https://github.com/cloudflare/cfssl/releases/download/v1.6.1/cfssl_1.6.1_linux_amd64
wget https://github.com/cloudflare/cfssl/releases/download/v1.6.1/cfssljson_1.6.1_linux_amd64
wget https://github.com/cloudflare/cfssl/releases/download/v1.6.1/cfssl-certinfo_1.6.1_linux_amd64 
chmod +x cfssl_1.6.1_linux_amd64 cfssljson_1.6.1_linux_amd64 cfssl-certinfo_1.6.1_linux_amd64 
mv cfssl_1.6.1_linux_amd64 /usr/bin/cfssl
mv cfssljson_1.6.1_linux_amd64 /usr/bin/cfssljson
mv cfssl-certinfo_1.6.1_linux_amd64  /usr/bin/cfssl-certinfo

mkdir -p ~/ssl/{etcd,k8s}
cd ~/ssl/etcd

#è‡ªç­¾CAï¼š
cat > ca-config.json << EOF
{
  "signing": {
    "default": {
      "expiry": "87600h"
    },
    "profiles": {
      "www": {
         "expiry": "87600h",
         "usages": [
            "signing",
            "key encipherment",
            "server auth",
            "client auth"
        ]
      }
    }
  }
}
EOF

cat > ca-csr.json << EOF
{
    "CN": "etcd CA",
    "key": {
        "algo": "rsa",
        "size": 2048
    },
    "names": [
        {
            "C": "CN",
            "L": "Beijing",
            "ST": "Beijing"
        }
    ]
}
EOF

#ç”Ÿæˆè¯ä¹¦ï¼š
cfssl gencert -initca ca-csr.json | cfssljson -bare ca -

#ä½¿ç”¨è‡ªç­¾CAç­¾å‘Etcd HTTPSè¯ä¹¦
cat > server-csr.json << EOF
{
    "CN": "etcd",
    "hosts": [
    "10.199.10.231",
    "10.199.10.232",
    "10.199.10.233",
    "10.199.10.234",
    "10.199.10.235",
    "10.199.10.236",
    "10.199.10.237",
    "10.199.10.238",
    "10.199.10.239",
    "10.199.10.230"
    ],
    "key": {
        "algo": "rsa",
        "size": 2048
    },
    "names": [
        {
            "C": "CN",
            "L": "BeiJing",
            "ST": "BeiJing"
        }
    ]
}
EOF

#æ³¨ï¼šä¸Šè¿°æ–‡ä»¶hostså­—æ®µä¸­IPä¸ºæ‰€æœ‰etcdèŠ‚ç‚¹çš„é›†ç¾¤å†…éƒ¨é€šä¿¡IPï¼Œä¸€ä¸ªéƒ½ä¸èƒ½å°‘ï¼ä¸ºäº†æ–¹ä¾¿åæœŸæ‰©å®¹å¯ä»¥å¤šå†™å‡ ä¸ªé¢„ç•™çš„IPã€‚
#ç”Ÿæˆè¯ä¹¦ï¼š
cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=www server-csr.json | cfssljson -bare server

#ä¼šç”Ÿæˆserver.pemå’Œserver-key.pemæ–‡ä»¶ã€‚
```

### 1.4 éƒ¨ç½²etcd

#### 1. Etcd çš„æ¦‚å¿µï¼š
Etcd æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼é”®å€¼å­˜å‚¨ç³»ç»Ÿï¼ŒKubernetesä½¿ç”¨Etcdè¿›è¡Œæ•°æ®å­˜å‚¨ï¼Œæ‰€ä»¥å…ˆå‡†å¤‡ä¸€ä¸ªEtcdæ•°æ®åº“ï¼Œä¸ºè§£å†³Etcdå•ç‚¹æ•…éšœï¼Œåº”é‡‡ç”¨é›†ç¾¤æ–¹å¼éƒ¨ç½²ï¼Œè¿™é‡Œä½¿ç”¨3å°ç»„å»ºé›†ç¾¤ï¼Œå¯å®¹å¿1å°æœºå™¨æ•…éšœï¼Œå½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨5å°ç»„å»ºé›†ç¾¤ï¼Œå¯å®¹å¿2å°æœºå™¨æ•…éšœã€‚

ä¸‹è½½åœ°å€ï¼š https://github.com/etcd-io/etcd/releases

å®‰è£…é…ç½®etcd

```shell
mkdir /opt/etcd/{bin,cfg,ssl} -p
cd ~
wget https://github.com/etcd-io/etcd/releases/download/v3.5.4/etcd-v3.5.4-linux-amd64.tar.gz
tar zxvf etcd-v3.5.4-linux-amd64.tar.gz
mv etcd-v3.5.4-linux-amd64/{etcd,etcdctl} /opt/etcd/bin/

cat > /opt/etcd/cfg/etcd.conf << EOF
#[Member]
ETCD_NAME="etcd-1"
ETCD_DATA_DIR="/var/lib/etcd/default.etcd"
ETCD_LISTEN_PEER_URLS="https://10.199.10.231:2380"
ETCD_LISTEN_CLIENT_URLS="https://10.199.10.231:2379"
#[Clustering]
ETCD_INITIAL_ADVERTISE_PEER_URLS="https://10.199.10.231:2380"
ETCD_ADVERTISE_CLIENT_URLS="https://10.199.10.231:2379"
ETCD_INITIAL_CLUSTER="etcd-1=https://10.199.10.231:2380,etcd-2=https://10.199.10.232:2380,etcd-3=https://10.199.10.233:2380"
ETCD_INITIAL_CLUSTER_TOKEN="etcd-cluster"
ETCD_INITIAL_CLUSTER_STATE="new"

CLIENT_CERT_AUTH="true"
ETCD_TRUSTED_CA_FILE="/opt/etcd/ssl/ca.pem"
ETCD_CERT_FILE="/opt/etcd/ssl/server.pem"
ETCD_KEY_FILE="/opt/etcd/ssl/server-key.pem"
PEER_CLIENT_CERT_AUTH="true"
ETCD_PEER_TRUSTED_CA_FILE="/opt/etcd/ssl/ca.pem"
ETCD_PEER_CERT_FILE="/opt/etcd/ssl/server.pem"
ETCD_PEER_KEY_FILE="/opt/etcd/ssl/server-key.pem"
EOF
```

ETCD_NAMEï¼šèŠ‚ç‚¹åç§°ï¼Œé›†ç¾¤ä¸­å”¯ä¸€
ETCD_DATA_DIRï¼šæ•°æ®ç›®å½•
ETCD_LISTEN_PEER_URLSï¼šé›†ç¾¤é€šä¿¡ç›‘å¬åœ°å€
ETCD_LISTEN_CLIENT_URLSï¼šå®¢æˆ·ç«¯è®¿é—®ç›‘å¬åœ°å€
ETCD_INITIAL_ADVERTISE_PEER_URLSï¼šé›†ç¾¤é€šå‘Šåœ°å€
ETCD_ADVERTISE_CLIENT_URLSï¼šå®¢æˆ·ç«¯é€šå‘Šåœ°å€
ETCD_INITIAL_CLUSTERï¼šé›†ç¾¤èŠ‚ç‚¹åœ°å€
ETCD_INITIAL_CLUSTER_TOKENï¼šé›†ç¾¤Token
ETCD_INITIAL_CLUSTER_STATEï¼šåŠ å…¥é›†ç¾¤çš„å½“å‰çŠ¶æ€ï¼Œnewæ˜¯æ–°é›†ç¾¤ï¼Œexistingè¡¨ç¤ºåŠ å…¥å·²æœ‰é›†ç¾¤

#### 2.systemdç®¡ç†etcd

```shell
cat > /usr/lib/systemd/system/etcd.service << EOF
[Unit]
Description=Etcd Server
After=network.target
After=network-online.target
Wants=network-online.target

[Service]
Type=notify
EnvironmentFile=/opt/etcd/cfg/etcd.conf
ExecStart=/opt/etcd/bin/etcd --logger=zap
Restart=on-failure
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
EOF

cp ~/ssl/etcd/ca*pem /opt/etcd/ssl/
cp ~/ssl/etcd/server*pem /opt/etcd/ssl/
#åŒæ­¥æ‰€æœ‰ä¸»æœº
scp -r /opt/etcd/ root@master02:/opt/
scp -r /opt/etcd/ root@master03:/opt/
scp /usr/lib/systemd/system/etcd.service root@master02:/usr/lib/systemd/system/
scp /usr/lib/systemd/system/etcd.service root@master03:/usr/lib/systemd/system/

#ä¿®æ”¹master02 master03çš„é…ç½®æ–‡ä»¶
vim /opt/etcd/cfg/etcd.conf 

#ETCD_NAME ETCD_LISTEN_PEER_URLS ETCD_LISTEN_CLIENT_URLS
#ETCD_INITIAL_ADVERTISE_PEER_URLS ETCD_ADVERTISE_CLIENT_URLS

systemctl daemon-reload
systemctl start etcd
systemctl enable etcd

#éªŒè¯
ETCDCTL_API=3 /opt/etcd/bin/etcdctl --cacert=/opt/etcd/ssl/ca.pem --cert=/opt/etcd/ssl/server.pem --key=/opt/etcd/ssl/server-key.pem --endpoints="https://10.199.10.231:2379,https://10.199.10.232:2379,https://10.199.10.233:2379" endpoint health --write-out=table
```

+----------------------------+--------+-------------+-------+
|          ENDPOINT          | HEALTH |    TOOK     | ERROR |
+----------------------------+--------+-------------+-------+
| https://10.199.10.231:2379 |   true | 16.242785ms |       |
| https://10.199.10.232:2379 |   true | 16.057478ms |       |
| https://10.199.10.233:2379 |   true | 23.245594ms |       |
+----------------------------+--------+-------------+-------+

### 1.5 å®‰è£…é«˜å¯ç”¨ç»„ä»¶nginx

```shell
mkdir /var/log/nginx -p
yum install nginx nginx-mod-stream keepalived -y

cat >/etc/nginx/nginx.conf<<EOF 
user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log;
pid /run/nginx.pid;
include /usr/share/nginx/modules/*.conf;

events {
    worker_connections  3000;
}

stream {
    log_format main '\$remote_addr \$upstream_addr - [\$time_local] \$status \$upstream_bytes_sent';
    access_log /var/log/nginx/k8s-access.log main;

    upstream apiservers {
        server 10.199.10.231:6443  max_fails=2 fail_timeout=3s;
        server 10.199.10.232:6443  max_fails=2 fail_timeout=3s;
        server 10.199.10.233:6443  max_fails=2 fail_timeout=3s;
    }

    server {
        listen 16443;
        proxy_connect_timeout 1s;
        proxy_pass apiservers;
    }
}
EOF

systemctl enable --now nginx.service
#éªŒè¯
ss -ntl | grep 16443
LISTEN     0      511    127.0.0.1:16443                    *:*
```

### 1.5 keepalive é…ç½®

ä¸» keepalived

```shell
cat >/etc/keepalived/keepalived.conf<<EOF 
global_defs {
   router_id NGINX
   notification_email {
     acassen@firewall.loc
     failover@firewall.loc
     sysadmin@firewall.loc
   }
   notification_email_from Alexandre.Cassen@firewall.loc
   smtp_server 127.0.0.1
   smtp_connect_timeout 30
}

vrrp_script check_nginx {
     script "/etc/keepalived/check_nginx.sh"
     interval 2
     weight 50
}

vrrp_instance VI_1 {
    state MASTER
    interface ens33 # ä¿®æ”¹ä¸ºå®é™…ç½‘å¡å
    virtual_router_id 51 # è·¯ç”± ID å®ä¾‹ï¼Œæ¯ä¸ªå®ä¾‹æ˜¯å”¯ä¸€çš„
    priority 100 # ä¼˜å…ˆçº§ï¼Œå¤‡æœåŠ¡å™¨è®¾ç½® 90
    advert_int 1 # æŒ‡å®š VRRP å¿ƒè·³åŒ…é€šå‘Šé—´éš”æ—¶é—´ï¼Œé»˜è®¤ 1 ç§’
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    virtual_ipaddress {
        10.199.10.230
    }
    track_script {
      check_nginx
    }
}
EOF

cat >/etc/keepalived/check_nginx.sh<<EOF
#!/bin/bash
count=\$(ps -ef |grep nginx | grep sbin | egrep -cv "grep|\$\$")
if [ "\$count" -eq 0 ];then
     systemctl stop keepalived
fi
EOF

chmod +x /etc/keepalived/check_nginx.sh
```

å¤‡ keepalive

```shell
cat >/etc/keepalived/keepalived.conf<<EOF 
global_defs {
   router_id NGINX
   notification_email {
     acassen@firewall.loc
     failover@firewall.loc
     sysadmin@firewall.loc
   }
   notification_email_from Alexandre.Cassen@firewall.loc
   smtp_server 127.0.0.1
   smtp_connect_timeout 30
}

vrrp_script check_nginx {
     script "/etc/keepalived/check_nginx.sh"
     interval 2
     weight 50
}

vrrp_instance VI_1 {
    state BACKUP
    interface ens33 # ä¿®æ”¹ä¸ºå®é™…ç½‘å¡å
    virtual_router_id 51 # è·¯ç”± ID å®ä¾‹ï¼Œæ¯ä¸ªå®ä¾‹æ˜¯å”¯ä¸€çš„
    priority 90 # ä¼˜å…ˆçº§ï¼Œå¤‡æœåŠ¡å™¨è®¾ç½® 90
    advert_int 1 # æŒ‡å®š VRRP å¿ƒè·³åŒ…é€šå‘Šé—´éš”æ—¶é—´ï¼Œé»˜è®¤ 1 ç§’
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    virtual_ipaddress {
        10.199.10.230/24
    }
    track_script {
      check_nginx
    }
}
EOF

cat >/etc/keepalived/check_nginx.sh<<EOF
#!/bin/bash
count=\$(ps -ef |grep nginx | grep sbin | egrep -cv "grep|\$\$")
if [ "\$count" -eq 0 ];then
     systemctl stop keepalived
fi
EOF

chmod +x /etc/keepalived/check_nginx.sh
```

ä¸»å¤‡å¯åŠ¨æœåŠ¡

```shell
#æ·»åŠ æ‰§è¡Œç”¨æˆ·
groupadd -r keepalived_script
useradd -r -s /sbin/nologin -g keepalived_script -M keepalived_script

systemctl daemon-reload
systemctl start nginx
systemctl restart keepalived
systemctl enable nginx keepalived
systemctl status keepalived
#æµ‹è¯• vip æ˜¯å¦ç»‘å®šæˆåŠŸ
ip addr
```

## äºŒã€éƒ¨ç½² kubernetes

### 2.1 k8s æœ€æ–°ç‰ˆæœ¬çš„ä¸‹è½½

1. ä»Githubä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶
ä¸‹è½½åœ°å€ï¼š 
https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.24.md
æ³¨ï¼šæ‰“å¼€é“¾æ¥ä½ ä¼šå‘ç°é‡Œé¢æœ‰å¾ˆå¤šåŒ…ï¼Œä¸‹è½½ä¸€ä¸ªserveråŒ…å°±å¤Ÿäº†ï¼ŒåŒ…å«äº†Masterå’ŒWorker NodeäºŒè¿›åˆ¶æ–‡ä»¶ã€‚
https://dl.k8s.io/v1.24.3/kubernetes-server-linux-amd64.tar.gz

### 2.2 åˆ›å»ºk8s çš„kube-apiserverè¯ä¹¦

```shell
cd ~/ssl/k8s

cat > ca-config.json << EOF
{
  "signing": {
    "default": {
      "expiry": "87600h"
    },
    "profiles": {
      "kubernetes": {
         "expiry": "87600h",
         "usages": [
            "signing",
            "key encipherment",
            "server auth",
            "client auth"
        ]
      }
    }
  }
}
EOF
cat > ca-csr.json << EOF
{
    "CN": "kubernetes",
    "key": {
        "algo": "rsa",
        "size": 2048
    },
    "names": [
        {
            "C": "CN",
            "L": "Beijing",
            "ST": "Beijing",
            "O": "k8s",
            "OU": "System"
        }
    ]
}
EOF

#ç”Ÿæˆè¯ä¹¦ï¼š
cfssl gencert -initca ca-csr.json | cfssljson -bare ca -
```

ä¼šç”Ÿæˆca.pemå’Œca-key.pemæ–‡ä»¶ã€‚

ä½¿ç”¨è‡ªç­¾CAç­¾å‘kube-apiserver HTTPSè¯ä¹¦

```shell
cat > server-csr.json << EOF
{
    "CN": "kubernetes",
    "hosts": [
      "10.200.0.1",
      "10.0.0.1",
      "127.0.0.1",
      "10.199.10.231",
      "10.199.10.232",
      "10.199.10.233",
      "10.199.10.234",
      "10.199.10.235",
      "10.199.10.236",
      "10.199.10.237",
      "10.199.10.238",
      "10.199.10.239",
      "10.199.10.230",
      "kubernetes",
      "kubernetes.default",
      "kubernetes.default.svc",
      "kubernetes.default.svc.cluster",
      "kubernetes.default.svc.cluster.local"
    ],
    "key": {
        "algo": "rsa",
        "size": 2048
    },
    "names": [
        {
            "C": "CN",
            "L": "BeiJing",
            "ST": "BeiJing",
            "O": "k8s",
            "OU": "System"
        }
    ]
}
EOF

cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes server-csr.json | cfssljson -bare server
```

æ³¨ï¼šä¸Šè¿°æ–‡ä»¶hostså­—æ®µä¸­IPä¸ºæ‰€æœ‰Master/LB/VIP IPï¼Œä¸€ä¸ªéƒ½ä¸èƒ½å°‘ï¼ä¸ºäº†æ–¹ä¾¿åæœŸæ‰©å®¹å¯ä»¥å¤šå†™å‡ ä¸ªé¢„ç•™çš„IPã€‚
ä¼šç”Ÿæˆserver.pemå’Œserver-key.pemæ–‡ä»¶ã€‚

### 2.3 éƒ¨ç½²kube-apiserver

```shell
#åŸºç¡€åŒ…
mkdir -p /opt/kubernetes/{bin,cfg,ssl,logs} 
cd ~
tar -zxvf kubernetes-server-linux-amd64.tar.gz
cd kubernetes/server/bin
cp kube-apiserver kube-scheduler kube-controller-manager /opt/kubernetes/bin
cp kubectl /usr/bin/
cp kubectl /usr/local/bin/


cat > /opt/kubernetes/cfg/kube-apiserver.conf << EOF
KUBE_APISERVER_OPTS="--logtostderr=false \\
--v=2 \\
--log-dir=/opt/kubernetes/logs \\
--etcd-servers=https://10.199.10.231:2379,https://10.199.10.232:2379,https://10.199.10.233:2379 \\
--bind-address=10.199.10.231 \\
--secure-port=6443 \\
--advertise-address=10.199.10.231 \\
--allow-privileged=true \\
--service-cluster-ip-range=10.200.0.0/16 \\
--enable-admission-plugins=NodeRestriction \\
--authorization-mode=RBAC,Node \\
--enable-bootstrap-token-auth=true \\
--token-auth-file=/opt/kubernetes/cfg/token.csv \\
--service-node-port-range=30000-32767 \\
--kubelet-client-certificate=/opt/kubernetes/ssl/server.pem \\
--kubelet-client-key=/opt/kubernetes/ssl/server-key.pem \\
--tls-cert-file=/opt/kubernetes/ssl/server.pem  \\
--tls-private-key-file=/opt/kubernetes/ssl/server-key.pem \\
--client-ca-file=/opt/kubernetes/ssl/ca.pem \\
--service-account-key-file=/opt/kubernetes/ssl/ca-key.pem \\
--service-account-issuer=https://kubernetes.default.svc.cluster.local \\
--service-account-signing-key-file=/opt/kubernetes/ssl/ca-key.pem \\
--etcd-cafile=/opt/etcd/ssl/ca.pem \\
--etcd-certfile=/opt/etcd/ssl/server.pem \\
--etcd-keyfile=/opt/etcd/ssl/server-key.pem \\
--requestheader-client-ca-file=/opt/kubernetes/ssl/ca.pem \\
--proxy-client-cert-file=/opt/kubernetes/ssl/server.pem \\
--proxy-client-key-file=/opt/kubernetes/ssl/server-key.pem \\
--requestheader-allowed-names=kubernetes \\
--requestheader-extra-headers-prefix=X-Remote-Extra- \\
--requestheader-group-headers=X-Remote-Group \\
--requestheader-username-headers=X-Remote-User \\
--enable-aggregator-routing=true \\
--audit-log-maxage=30 \\
--audit-log-maxbackup=3 \\
--audit-log-maxsize=100 \\
--audit-log-path=/opt/kubernetes/logs/k8s-audit.log"
EOF
```

æ³¨ï¼šä¸Šé¢ä¸¤ä¸ª\ \ ç¬¬ä¸€ä¸ªæ˜¯è½¬ä¹‰ç¬¦ï¼Œç¬¬äºŒä¸ªæ˜¯æ¢è¡Œç¬¦ï¼Œä½¿ç”¨è½¬ä¹‰ç¬¦æ˜¯ä¸ºäº†ä½¿ç”¨EOFä¿ç•™æ¢è¡Œç¬¦ã€‚
â€¢ --logtostderrï¼šå¯ç”¨æ—¥å¿—
â€¢ ---vï¼šæ—¥å¿—ç­‰çº§
â€¢ --log-dirï¼šæ—¥å¿—ç›®å½•
â€¢ --etcd-serversï¼šetcdé›†ç¾¤åœ°å€
â€¢ --bind-addressï¼šç›‘å¬åœ°å€
â€¢ --secure-portï¼šhttpså®‰å…¨ç«¯å£
â€¢ --advertise-addressï¼šé›†ç¾¤é€šå‘Šåœ°å€
â€¢ --allow-privilegedï¼šå¯ç”¨æˆæƒ
â€¢ --service-cluster-ip-rangeï¼šServiceè™šæ‹ŸIPåœ°å€æ®µ
â€¢ --enable-admission-pluginsï¼šå‡†å…¥æ§åˆ¶æ¨¡å—
â€¢ --authorization-modeï¼šè®¤è¯æˆæƒï¼Œå¯ç”¨RBACæˆæƒå’ŒèŠ‚ç‚¹è‡ªç®¡ç†
â€¢ --enable-bootstrap-token-authï¼šå¯ç”¨TLS bootstrapæœºåˆ¶
â€¢ --token-auth-fileï¼šbootstrap tokenæ–‡ä»¶
â€¢ --service-node-port-rangeï¼šService nodeportç±»å‹é»˜è®¤åˆ†é…ç«¯å£èŒƒå›´
â€¢ --kubelet-client-xxxï¼šapiserverè®¿é—®kubeletå®¢æˆ·ç«¯è¯ä¹¦
â€¢ --tls-xxx-fileï¼šapiserver httpsè¯ä¹¦
â€¢ 1.20ç‰ˆæœ¬å¿…é¡»åŠ çš„å‚æ•°ï¼š--service-account-issuerï¼Œ--service-account-signing-key-file
â€¢ --etcd-xxxfileï¼šè¿æ¥Etcdé›†ç¾¤è¯ä¹¦
â€¢ --audit-log-xxxï¼šå®¡è®¡æ—¥å¿—
â€¢ å¯åŠ¨èšåˆå±‚ç›¸å…³é…ç½®ï¼š--requestheader-client-ca-fileï¼Œ--proxy-client-cert-fileï¼Œ--proxy-client-key-fileï¼Œ--requestheader-allowed-namesï¼Œ--requestheader-extra-headers-prefixï¼Œ--requestheader-group-headersï¼Œ--requestheader-username-headersï¼Œ--enable-aggregator-routing

å¯ç”¨ TLS Bootstrapping æœºåˆ¶
TLS Bootstrapingï¼šMaster apiserverå¯ç”¨TLSè®¤è¯åï¼ŒNodeèŠ‚ç‚¹kubeletå’Œkube-proxyè¦ä¸kube-apiserverè¿›è¡Œé€šä¿¡ï¼Œå¿…é¡»ä½¿ç”¨CAç­¾å‘çš„æœ‰æ•ˆè¯ä¹¦æ‰å¯ä»¥ï¼Œå½“NodeèŠ‚ç‚¹å¾ˆå¤šæ—¶ï¼Œè¿™ç§å®¢æˆ·ç«¯è¯ä¹¦é¢å‘éœ€è¦å¤§é‡å·¥ä½œï¼ŒåŒæ ·ä¹Ÿä¼šå¢åŠ é›†ç¾¤æ‰©å±•å¤æ‚åº¦ã€‚ä¸ºäº†ç®€åŒ–æµç¨‹ï¼ŒKuberneteså¼•å…¥äº†TLS bootstrapingæœºåˆ¶æ¥è‡ªåŠ¨é¢å‘å®¢æˆ·ç«¯è¯ä¹¦ï¼Œkubeletä¼šä»¥ä¸€ä¸ªä½æƒé™ç”¨æˆ·è‡ªåŠ¨å‘apiserverç”³è¯·è¯ä¹¦ï¼Œkubeletçš„è¯ä¹¦ç”±apiserveråŠ¨æ€ç­¾ç½²ã€‚æ‰€ä»¥å¼ºçƒˆå»ºè®®åœ¨Nodeä¸Šä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œç›®å‰ä¸»è¦ç”¨äºkubeletï¼Œkube-proxyè¿˜æ˜¯ç”±æˆ‘ä»¬ç»Ÿä¸€é¢å‘ä¸€ä¸ªè¯ä¹¦ã€‚

```shell
head -c 16 /dev/urandom | od -An -t x | tr -d ' '
#æ ¼å¼ï¼štokenï¼Œç”¨æˆ·åï¼ŒUIDï¼Œç”¨æˆ·ç»„
cat > /opt/kubernetes/cfg/token.csv << EOF
6e80d5442227f1ae80a6957df007c4c2,kubelet-bootstrap,10001,"system:node-bootstrapper"
EOF

#å¤åˆ¶è¯ä¹¦
cp ~/ssl/k8s/ca*pem ~/ssl/k8s/server*pem /opt/kubernetes/ssl/


cat > /usr/lib/systemd/system/kube-apiserver.service << EOF
[Unit]
Description=Kubernetes API Server
Documentation=https://github.com/kubernetes/kubernetes

[Service]
EnvironmentFile=/opt/kubernetes/cfg/kube-apiserver.conf
ExecStart=/opt/kubernetes/bin/kube-apiserver \$KUBE_APISERVER_OPTS
Restart=on-failure

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl restart kube-apiserver 
systemctl enable kube-apiserver
systemctl status kube-apiserver
```

### 2.4 éƒ¨ç½²kube-controller-manager

ç”Ÿæˆkubeconfigæ–‡ä»¶

```shell
cd ~/ssl/k8s

# åˆ›å»ºè¯ä¹¦è¯·æ±‚æ–‡ä»¶
cat > kube-controller-manager-csr.json << EOF
{
  "CN": "system:kube-controller-manager",
  "hosts": [],
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "L": "BeiJing", 
      "ST": "BeiJing",
      "O": "system:masters",
      "OU": "System"
    }
  ]
}
EOF

# ç”Ÿæˆè¯ä¹¦
cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-controller-manager-csr.json | cfssljson -bare kube-controller-manager

#ç”Ÿæˆkubeconfigæ–‡ä»¶
KUBE_CONFIG="/opt/kubernetes/cfg/kube-controller-manager.kubeconfig"
KUBE_APISERVER="https://10.199.10.230:16443"

kubectl config set-cluster kubernetes \
  --certificate-authority=/opt/kubernetes/ssl/ca.pem \
  --embed-certs=true \
  --server=${KUBE_APISERVER} \
  --kubeconfig=${KUBE_CONFIG}
kubectl config set-credentials kube-controller-manager \
  --client-certificate=./kube-controller-manager.pem \
  --client-key=./kube-controller-manager-key.pem \
  --embed-certs=true \
  --kubeconfig=${KUBE_CONFIG}
kubectl config set-context default \
  --cluster=kubernetes \
  --user=kube-controller-manager \
  --kubeconfig=${KUBE_CONFIG}
kubectl config use-context default --kubeconfig=${KUBE_CONFIG}

#åˆ›å»ºé…ç½®æ–‡ä»¶
cat > /opt/kubernetes/cfg/kube-controller-manager.conf << EOF
KUBE_CONTROLLER_MANAGER_OPTS="--logtostderr=false \\
--v=2 \\
--log-dir=/opt/kubernetes/logs \\
--leader-elect=true \\
--kubeconfig=/opt/kubernetes/cfg/kube-controller-manager.kubeconfig \\
--bind-address=127.0.0.1 \\
--allocate-node-cidrs=true \\
--cluster-cidr=10.244.0.0/16 \\
--service-cluster-ip-range=10.200.0.0/16 \\
--cluster-signing-cert-file=/opt/kubernetes/ssl/ca.pem \\
--cluster-signing-key-file=/opt/kubernetes/ssl/ca-key.pem  \\
--root-ca-file=/opt/kubernetes/ssl/ca.pem \\
--service-account-private-key-file=/opt/kubernetes/ssl/ca-key.pem \\
--cluster-signing-duration=87600h0m0s"
EOF


#systemdç®¡ç†controller-manager
cat > /usr/lib/systemd/system/kube-controller-manager.service << EOF
[Unit]
Description=Kubernetes Controller Manager
Documentation=https://github.com/kubernetes/kubernetes

[Service]
EnvironmentFile=/opt/kubernetes/cfg/kube-controller-manager.conf
ExecStart=/opt/kubernetes/bin/kube-controller-manager \$KUBE_CONTROLLER_MANAGER_OPTS
Restart=on-failure

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl restart kube-controller-manager
systemctl enable kube-controller-manager
systemctl status kube-controller-manager
```

### 2.5 éƒ¨ç½²kube-scheduler

```shell
#åˆ›å»ºé…ç½®æ–‡ä»¶
cat > /opt/kubernetes/cfg/kube-scheduler.conf << EOF
KUBE_SCHEDULER_OPTS="--logtostderr=false \\
--v=2 \\
--log-dir=/opt/kubernetes/logs \\
--leader-elect \\
--kubeconfig=/opt/kubernetes/cfg/kube-scheduler.kubeconfig \\
--bind-address=127.0.0.1"
EOF

#ç”Ÿæˆkube-schedulerè¯ä¹¦
cd ~/ssl/k8s
cat > kube-scheduler-csr.json << EOF
{
  "CN": "system:kube-scheduler",
  "hosts": [],
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "L": "BeiJing",
      "ST": "BeiJing",
      "O": "system:masters",
      "OU": "System"
    }
  ]
}
EOF

# ç”Ÿæˆè¯ä¹¦
cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-scheduler-csr.json | cfssljson -bare kube-scheduler

#ç”Ÿæˆkubeconfigæ–‡ä»¶ï¼š
KUBE_CONFIG="/opt/kubernetes/cfg/kube-scheduler.kubeconfig"
KUBE_APISERVER="https://10.199.10.230:16443"

kubectl config set-cluster kubernetes \
  --certificate-authority=/opt/kubernetes/ssl/ca.pem \
  --embed-certs=true \
  --server=${KUBE_APISERVER} \
  --kubeconfig=${KUBE_CONFIG}
kubectl config set-credentials kube-scheduler \
  --client-certificate=./kube-scheduler.pem \
  --client-key=./kube-scheduler-key.pem \
  --embed-certs=true \
  --kubeconfig=${KUBE_CONFIG}
kubectl config set-context default \
  --cluster=kubernetes \
  --user=kube-scheduler \
  --kubeconfig=${KUBE_CONFIG}
kubectl config use-context default --kubeconfig=${KUBE_CONFIG}

#systemdç®¡ç†scheduler
cat > /usr/lib/systemd/system/kube-scheduler.service << EOF
[Unit]
Description=Kubernetes Scheduler
Documentation=https://github.com/kubernetes/kubernetes

[Service]
EnvironmentFile=/opt/kubernetes/cfg/kube-scheduler.conf
ExecStart=/opt/kubernetes/bin/kube-scheduler \$KUBE_SCHEDULER_OPTS
Restart=on-failure

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl restart kube-scheduler
systemctl enable kube-scheduler
systemctl status kube-scheduler
```

### 2.6 æŸ¥çœ‹é›†ç¾¤çŠ¶æ€

ç”Ÿæˆkubectlè¿æ¥é›†ç¾¤çš„è¯ä¹¦

```shell
cd ~/ssl/k8s/
cat > admin-csr.json <<EOF
{
  "CN": "admin",
  "hosts": [],
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "L": "BeiJing",
      "ST": "BeiJing",
      "O": "system:masters",
      "OU": "System"
    }
  ]
}
EOF

cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes admin-csr.json | cfssljson -bare admin
```

ç”Ÿæˆkubeconfigæ–‡ä»¶

```shell
KUBE_CONFIG="/root/.kube/config"
KUBE_APISERVER="https://10.199.10.230:16443"

kubectl config set-cluster kubernetes \
  --certificate-authority=/opt/kubernetes/ssl/ca.pem \
  --embed-certs=true \
  --server=${KUBE_APISERVER} \
  --kubeconfig=${KUBE_CONFIG}
kubectl config set-credentials cluster-admin \
  --client-certificate=./admin.pem \
  --client-key=./admin-key.pem \
  --embed-certs=true \
  --kubeconfig=${KUBE_CONFIG}
kubectl config set-context default \
  --cluster=kubernetes \
  --user=cluster-admin \
  --kubeconfig=${KUBE_CONFIG}
kubectl config use-context default --kubeconfig=${KUBE_CONFIG}

#é€šè¿‡kubectlå·¥å…·æŸ¥çœ‹å½“å‰é›†ç¾¤ç»„ä»¶çŠ¶æ€
kubectl get cs

Warning: v1 ComponentStatus is deprecated in v1.19+
NAME                 STATUS    MESSAGE                         ERROR
scheduler            Healthy   ok
controller-manager   Healthy   ok
etcd-0               Healthy   {"health":"true","reason":""}
etcd-2               Healthy   {"health":"true","reason":""}
etcd-1               Healthy   {"health":"true","reason":""}

#æˆæƒkubelet-bootstrapç”¨æˆ·å…è®¸è¯·æ±‚è¯ä¹¦
kubectl create clusterrolebinding kubelet-bootstrap \
--clusterrole=system:node-bootstrapper \
--user=kubelet-bootstrap
```

åŒæ­¥å¦å¤–ä¸¤ä¸ªmasterèŠ‚ç‚¹

```shell
mkdir -p /opt/kubernetes/{bin,cfg,ssl,logs} 
#master01
cd /opt/kubernetes
scp -r bin cfg ssl master02:/opt/kubernetes
scp -r bin cfg ssl master03:/opt/kubernetes
cd /usr/lib/systemd/system/
scp kube-apiserver.service kube-controller-manager.service kube-scheduler.service master02:/usr/lib/systemd/system/
scp kube-apiserver.service kube-controller-manager.service kube-scheduler.service master03:/usr/lib/systemd/system/

#master02 master03
mkdir -p /root/.kube
#master01
scp /root/.kube/config master02:/root/.kube/config
scp /root/.kube/config master03:/root/.kube/config

scp /usr/bin/kubectl master02:/usr/bin
scp /usr/bin/kubectl master03:/usr/bin
#ä¿®æ”¹é…ç½®
vi /opt/kubernetes/cfg/kube-apiserver.conf
#åé¢çš„å†…å®¹æ”¹ä¸ºå½“å‰ä¸»æœºçš„IP
--bind-address=
--advertise-address=

systemctl daemon-reload
systemctl restart kube-apiserver 
systemctl enable kube-apiserver
systemctl status kube-apiserver

systemctl restart kube-controller-manager
systemctl enable kube-controller-manager
systemctl status kube-controller-manager

systemctl restart kube-scheduler
systemctl enable kube-scheduler
systemctl status kube-scheduler
```

## ä¸‰ã€éƒ¨ç½²workerèŠ‚ç‚¹

### 3.1 åˆ›å»ºå·¥ä½œç›®å½•å¹¶æ‹·è´äºŒè¿›åˆ¶æ–‡ä»¶

åœ¨æ‰€æœ‰worker nodeåˆ›å»ºå·¥ä½œç›®å½•ï¼š

```shell
#ä»èŠ‚ç‚¹åˆ›å»ºç›®å½•
mkdir -p /opt/kubernetes/{bin,cfg,ssl,logs}

#masterèŠ‚ç‚¹æ‹·è´ï¼š
cd ~/kubernetes/server/bin
cp kubelet kube-proxy /opt/kubernetes/bin   # æœ¬åœ°æ‹·è´
#åˆ†å‘
scp -r kubelet kube-proxy node01:/opt/kubernetes/bin
scp -r kubelet kube-proxy node02:/opt/kubernetes/bin

scp /opt/kubernetes/ssl/ca.pem node01:/opt/kubernetes/ssl
scp /opt/kubernetes/ssl/ca.pem node02:/opt/kubernetes/ssl

```

### 3.2 éƒ¨ç½²kubelet

åˆ›å»ºé…ç½®æ–‡ä»¶

```shell
cat > /opt/kubernetes/cfg/kubelet.conf << EOF
KUBELET_OPTS="--logtostderr=false \\
--v=2 \\
--log-dir=/opt/kubernetes/logs \\
--hostname-override=node01 \\
--kubeconfig=/opt/kubernetes/cfg/kubelet.kubeconfig \\
--bootstrap-kubeconfig=/opt/kubernetes/cfg/bootstrap.kubeconfig \\
--config=/opt/kubernetes/cfg/kubelet-config.yml \\
--cert-dir=/opt/kubernetes/ssl \\
--container-runtime=remote  \\
--runtime-request-timeout=15m  \\
--container-runtime-endpoint=unix:///run/containerd/containerd.sock  \\
--cgroup-driver=systemd \\
--node-labels=node.kubernetes.io/node='' \\
--feature-gates=IPv6DualStack=true"
EOF

#ä¸åŒèŠ‚ç‚¹ä¸»æœºåä¿®æ”¹--hostname-override=

#é…ç½®å‚æ•°æ–‡ä»¶
cat > /opt/kubernetes/cfg/kubelet-config.yml << EOF
kind: KubeletConfiguration
apiVersion: kubelet.config.k8s.io/v1beta1
address: 0.0.0.0
port: 10250
readOnlyPort: 10255
cgroupDriver: systemd
clusterDNS:
- 10.200.0.2
clusterDomain: cluster.local 
failSwapOn: false
authentication:
  anonymous:
    enabled: false
  webhook:
    cacheTTL: 2m0s
    enabled: true
  x509:
    clientCAFile: /opt/kubernetes/ssl/ca.pem 
authorization:
  mode: Webhook
  webhook:
    cacheAuthorizedTTL: 5m0s
    cacheUnauthorizedTTL: 30s
evictionHard:
  imagefs.available: 15%
  memory.available: 100Mi
  nodefs.available: 10%
  nodefs.inodesFree: 5%
maxOpenFiles: 1000000
maxPods: 110
EOF
```

åœ¨masterèŠ‚ç‚¹ç”Ÿæˆkubeletåˆæ¬¡åŠ å…¥é›†ç¾¤å¼•å¯¼kubeconfigæ–‡ä»¶

```shell
KUBE_CONFIG="/opt/kubernetes/cfg/bootstrap.kubeconfig"
KUBE_APISERVER="https://10.199.10.230:16443" # apiserver IP:PORT
TOKEN="6e80d5442227f1ae80a6957df007c4c2" # ä¸token.csvé‡Œä¿æŒä¸€è‡´

#åœ¨masterèŠ‚ç‚¹ ç”Ÿæˆ kubelet bootstrap kubeconfig é…ç½®æ–‡ä»¶
kubectl config set-cluster kubernetes \
  --certificate-authority=/opt/kubernetes/ssl/ca.pem \
  --embed-certs=true \
  --server=${KUBE_APISERVER} \
  --kubeconfig=${KUBE_CONFIG}
kubectl config set-credentials "kubelet-bootstrap" \
  --token=${TOKEN} \
  --kubeconfig=${KUBE_CONFIG}
kubectl config set-context default \
  --cluster=kubernetes \
  --user="kubelet-bootstrap" \
  --kubeconfig=${KUBE_CONFIG}
kubectl config use-context default --kubeconfig=${KUBE_CONFIG}

scp /opt/kubernetes/cfg/bootstrap.kubeconfig node01:/opt/kubernetes/cfg
scp /opt/kubernetes/cfg/bootstrap.kubeconfig node02:/opt/kubernetes/cfg

#systemdç®¡ç†kubelet
cat > /usr/lib/systemd/system/kubelet.service << EOF
[Unit]
Description=Kubernetes Kubelet
After=docker.service

[Service]
EnvironmentFile=/opt/kubernetes/cfg/kubelet.conf
ExecStart=/opt/kubernetes/bin/kubelet \$KUBELET_OPTS
Restart=on-failure
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl restart kubelet
systemctl enable kubelet
systemctl status kubelet
```

æ‰¹å‡†kubeletè¯ä¹¦ç”³è¯·å¹¶åŠ å…¥é›†ç¾¤

```shell
kubectl get csr

NAME                                                   AGE   SIGNERNAME                                    REQUESTOR           REQUESTEDDURATION   CONDITION
node-csr-HiE30nQZo_oXPdE7gDkb7vSJDydoE1GxsAr_NPoUkcU   11m   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   <none>              Pending

# æ‰¹å‡†ç”³è¯·
kubectl certificate approve node-csr-HiE30nQZo_oXPdE7gDkb7vSJDydoE1GxsAr_NPoUkcU

# æŸ¥çœ‹èŠ‚ç‚¹
kubectl get node
```


### 3.3 éƒ¨ç½²kube-proxy

masterèŠ‚ç‚¹ ç”Ÿæˆkube-proxy.kubeconfigæ–‡ä»¶

```shell
cd ~/ssl/k8s
# åˆ›å»ºè¯ä¹¦è¯·æ±‚æ–‡ä»¶
cat > kube-proxy-csr.json << EOF
{
  "CN": "system:kube-proxy",
  "hosts": [],
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "L": "BeiJing",
      "ST": "BeiJing",
      "O": "k8s",
      "OU": "System"
    }
  ]
}
EOF

# ç”Ÿæˆè¯ä¹¦
cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy
#ç”Ÿæˆkubeconfigæ–‡ä»¶ï¼š
KUBE_CONFIG="/opt/kubernetes/cfg/kube-proxy.kubeconfig"
KUBE_APISERVER="https://10.199.10.230:16443"

kubectl config set-cluster kubernetes \
  --certificate-authority=/opt/kubernetes/ssl/ca.pem \
  --embed-certs=true \
  --server=${KUBE_APISERVER} \
  --kubeconfig=${KUBE_CONFIG}
kubectl config set-credentials kube-proxy \
  --client-certificate=./kube-proxy.pem \
  --client-key=./kube-proxy-key.pem \
  --embed-certs=true \
  --kubeconfig=${KUBE_CONFIG}
kubectl config set-context default \
  --cluster=kubernetes \
  --user=kube-proxy \
  --kubeconfig=${KUBE_CONFIG}
kubectl config use-context default --kubeconfig=${KUBE_CONFIG}
#åˆ†å‘å…¶å®ƒnodeèŠ‚ç‚¹
scp /opt/kubernetes/cfg/kube-proxy.kubeconfig node01:/opt/kubernetes/cfg
scp /opt/kubernetes/cfg/kube-proxy.kubeconfig node02:/opt/kubernetes/cfg
```

workèŠ‚ç‚¹åˆ›å»ºé…ç½®æ–‡ä»¶

```shell
cat > /opt/kubernetes/cfg/kube-proxy.conf << EOF
KUBE_PROXY_OPTS="--logtostderr=false \\
--v=2 \\
--log-dir=/opt/kubernetes/logs \\
--config=/opt/kubernetes/cfg/kube-proxy-config.yml"
EOF

cat > /opt/kubernetes/cfg/kube-proxy-config.yml << EOF
kind: KubeProxyConfiguration
apiVersion: kubeproxy.config.k8s.io/v1alpha1
bindAddress: 0.0.0.0
metricsBindAddress: 0.0.0.0:10249
clientConnection:
  kubeconfig: /opt/kubernetes/cfg/kube-proxy.kubeconfig
hostnameOverride: node01
clusterCIDR: 10.244.0.0/16
mode: ipvs
ipvs:
  scheduler: "rr"
iptables:
  masqueradeAll: true
EOF

#ä¸åŒèŠ‚ç‚¹çš„ä¸»æœºåä¿®æ”¹ hostnameOverride:

cat > /usr/lib/systemd/system/kube-proxy.service << EOF
[Unit]
Description=Kubernetes Proxy
After=network.target

[Service]
EnvironmentFile=/opt/kubernetes/cfg/kube-proxy.conf
ExecStart=/opt/kubernetes/bin/kube-proxy \$KUBE_PROXY_OPTS
Restart=on-failure
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
EOF
systemctl daemon-reload
systemctl restart kube-proxy
systemctl enable kube-proxy
systemctl status kube-proxy
```

### 3.4 æˆæƒapiserverè®¿é—®kubelet

åº”ç”¨åœºæ™¯ï¼šä¾‹å¦‚kubectl logs

```shell
cat > apiserver-to-kubelet-rbac.yaml << EOF
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  annotations:
    rbac.authorization.kubernetes.io/autoupdate: "true"
  labels:
    kubernetes.io/bootstrapping: rbac-defaults
  name: system:kube-apiserver-to-kubelet
rules:
  - apiGroups:
      - ""
    resources:
      - nodes/proxy
      - nodes/stats
      - nodes/log
      - nodes/spec
      - nodes/metrics
      - pods/log
    verbs:
      - "*"
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: system:kube-apiserver
  namespace: ""
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:kube-apiserver-to-kubelet
subjects:
  - apiGroup: rbac.authorization.k8s.io
    kind: User
    name: kubernetes
EOF

kubectl apply -f apiserver-to-kubelet-rbac.yaml
```

## å››ã€å…¶ä»–ç»„ä»¶å®‰è£…

### 4.1 calicoç½‘ç»œç»„ä»¶å®‰è£…

masterèŠ‚ç‚¹æ‰§è¡Œ

```shell
curl -Lsk https://docs.projectcalico.org/manifests/calico.yaml>calico.yaml 
vim +4434 calico.yaml
...
- name: CALICO_IPV4POOL_CIDR
  value: "10.244.0.0/16"

kubectl apply -f calico.yaml
#æŸ¥çœ‹é›†ç¾¤çŠ¶æ€
kubectl get pods -n kube-system
#calico çš„ STATUS çŠ¶æ€æ˜¯ Readyï¼Œè¯´æ˜ k8s é›†ç¾¤æ­£å¸¸è¿è¡Œäº†

#å®‰è£…calicoctlå·¥å…·
curl -O -L  https://github.com/projectcalico/calicoctl/releases/download/v3.15.5/calicoctl
chmod +x calicoctl 
mv calicoctl /usr/bin/
#é…ç½®calicoctl
mkdir /etc/calico -p
cat >/etc/calico/calicoctl.cfg <<EOF
apiVersion: projectcalico.org/v3
kind: CalicoAPIConfig
metadata:
spec:
  datastoreType: "kubernetes"
  kubeconfig: "/root/.kube/config"
EOF
#éªŒè¯
calicoctl node status

Calico process is running.
```

### 4.2 éƒ¨ç½²CoreDNS

https://github.com/coredns/deployment/tree/master/kubernetes

```shell
#helm å®‰è£…
helm repo add coredns https://coredns.github.io/helm
helm --namespace=kube-system install coredns coredns/coredns

#kubectl å®‰è£…
git clone https://github.com/coredns/deployment.git
mv deployment coredns
cd coredns/kubernetes

export CLUSTER_DNS_SVC_IP="10.200.0.2"
export CLUSTER_DNS_DOMAIN="cluster.local"

./deploy.sh -i ${CLUSTER_DNS_SVC_IP} -d ${CLUSTER_DNS_DOMAIN} | kubectl apply -f -
#./deploy.sh 10.3.0.0/24 | kubectl apply -f -
#kubectl delete --namespace=kube-system deployment kube-dns
#kubectl apply -f coredns.yaml

#æµ‹è¯•ç½‘ç»œæ˜¯å¦æ­£å¸¸
kubectl run busybox --image busybox:1.28 --restart=Never --rm -it busybox -- sh

/ # ping www.baidu.com
PING www.baidu.com (39.156.66.18): 56 data bytes
64 bytes from 39.156.66.18: seq=0 ttl=127 time=39.3 ms

#é€šè¿‡ä¸Šé¢å¯ä»¥çœ‹åˆ°èƒ½è®¿é—®ç½‘ç»œï¼Œè¯´æ˜ calico ç½‘ç»œæ’ä»¶å·²ç»è¢«æ­£å¸¸å®‰è£…äº†

/ # nslookup kubernetes.default.svc.cluster.local
Server:    10.96.0.10
Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local

Name:      kubernetes.default.svc.cluster.local
Address 1: 10.96.0.1 kubernetes.default.svc.cluster.local
#10.96.0.10 å°±æ˜¯æˆ‘ä»¬ coreDNS çš„ clusterIPï¼Œè¯´æ˜ coreDNS é…ç½®å¥½äº†ã€‚

#åˆ›å»ºä¸€ä¸ªnginx æµ‹è¯•
kubectl create deployment nginx --image=nginx
kubectl expose deployment nginx --port=80 --type=NodePort
kubectl get deploy,svc,pod 
```

### 4.3 å®‰è£…Metrics-server

https://github.com/kubernetes-sigs/metrics-server

é€‰æ‹©ç‰ˆæœ¬

```shell
curl -Lsk https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml>metrics.yaml
#éœ€è¦ä¿®æ”¹é…ç½®
        - --cert-dir=/tmp
        - --secure-port=4443
        - --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname
        - --kubelet-use-node-status-port
        - --metric-resolution=15s
        - --kubelet-insecure-tls  #æ·»åŠ è¿™ä¸ª

kubectl apply -f metrics.yaml
#éªŒè¯
kubectl top node 
```

æ³¨æ„æŸäº›ç‰ˆæœ¬ä¸æ­£å¸¸æ—¶

```shell
vim /opt/kubernetes/cfg/kube-apiserver.conf
#æ–°å¢åŠ å¦‚ä¸‹å†…å®¹ï¼š
--enable-aggregator-routing=true \

systemctl daemon-reload
systemctl restart kube-apiserver
```

### 4.4 å®‰è£…dashboard

https://github.com/kubernetes/dashboard

```shell
curl -Lsk https://raw.githubusercontent.com/kubernetes/dashboard/v2.6.0/aio/deploy/recommended.yaml>dashboard.yaml
#ä¿®æ”¹dashboard.yaml
kind: Service
apiVersion: v1
metadata:
  labels:
    k8s-app: kubernetes-dashboard
  name: kubernetes-dashboard
  namespace: kubernetes-dashboard
spec:
  type: NodePort  #æ·»åŠ 
  ports:
    - port: 443 
      targetPort: 8443
      nodePort: 30001  #æ·»åŠ 


kubectl apply -f dashboard.yaml
#éªŒè¯
kubectl get pods -n kubernetes-dashboard
kubectl get pods,svc -n kubernetes-dashboard

#åˆ›å»ºç”¨æˆ·
cat >admin.yaml<<EOF
apiVersion: v1
kind: ServiceAccount
metadata:
  name: admin-user
  namespace: kubernetes-dashboard
---
apiVersion: v1
kind: Secret
metadata:
  name: admin-user
  namespace: kubernetes-dashboard
  annotations:
    kubernetes.io/service-account.name: "admin-user"
type: kubernetes.io/service-account-token
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: admin-user
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- kind: ServiceAccount
  name: admin-user
  namespace: kubernetes-dashboard
EOF
kubectl apply -f admin.yaml
#åˆ›å»ºtoken 
kubectl -n kubernetes-dashboard create token admin-user
kubectl describe secrets -n kubernetes-dashboard admin-user


#æŸ¥çœ‹ dashboard å‰ç«¯çš„ service
#kubectl get svc -n kubernetes-dashboard
#ä¿®æ”¹ service type ç±»å‹å˜æˆ NodePort
#kubectl edit svc kubernetes-dashboard -n kubernetes-dashboard
#æŠŠ type: ClusterIP å˜æˆ type: NodePortï¼Œä¿å­˜é€€å‡ºå³å¯ã€‚
```

å¤åˆ¶tokenå¡«å…¥æµè§ˆå™¨çš„
æµè§ˆå™¨æ‰“å¼€ https://<nodeèŠ‚ç‚¹>:30001
[https://10.199.10.235:30001/](https://10.199.10.235:30001/)

### 4.5 å®‰è£…ciliumç½‘ç»œæ’ä»¶ï¼ˆå¯é€‰ï¼‰

```shell
#ä¸‹è½½å®¢æˆ·ç«¯å·¥å…·
wget https://github.com/cilium/cilium-cli/releases/download/v0.9.3/cilium-linux-amd64.tar.gz

#è§£å‹
tar xf cilium-linux-amd64.tar.gz -C /usr/bin/

#ä½¿ç”¨å‘½ä»¤å®‰è£…
cilium install
#æŸ¥çœ‹è¿è¡ŒçŠ¶æ€
cilium status

    /Â¯Â¯\
 /Â¯Â¯\__/Â¯Â¯\    Cilium:         OK
 \__/Â¯Â¯\__/    Operator:       OK
 /Â¯Â¯\__/Â¯Â¯\    Hubble:         disabled
 \__/Â¯Â¯\__/    ClusterMesh:    disabled
    \__/

DaemonSet         cilium             Desired: 2, Ready: 2/2, Available: 2/2
Deployment        cilium-operator    Desired: 1, Ready: 1/1, Available: 1/1
Containers:       cilium             Running: 2
                  cilium-operator    Running: 1
Cluster Pods:     23/46 managed by Cilium
Image versions    cilium             quay.io/cilium/cilium:v1.10.5: 2
                  cilium-operator    quay.io/cilium/operator-generic:v1.10.5: 1
```

å®‰è£…hubbleç»„ä»¶

```shell
cilium hubble enable

ğŸ”‘ Found existing CA in secret cilium-ca
âœ¨ Patching ConfigMap cilium-config to enable Hubble...
â™»ï¸  Restarted Cilium pods
âŒ› Waiting for Cilium to become ready before deploying other Hubble component(s)...
ğŸ”‘ Generating certificates for Relay...
âœ¨ Deploying Relay from quay.io/cilium/hubble-relay:v1.10.5...
âŒ› Waiting for Hubble to be installed...
âœ… Hubble was successfully enabled!
#å¯ç”¨hubble-ui
cilium hubble enable --ui

#æŸ¥çœ‹çŠ¶æ€
cilium status

#ä¿®æ”¹service
kubectl edit service -n kube-system hubble-ui

spec:
  clusterIP: 10.200.40.172
  ports:  
  - port: 80
    protocol: TCP
    targetPort: 8081
    nodePort: 30002  #æ·»åŠ 
  selector:
    k8s-app: hubble-ui
  sessionAffinity: None
  type: NodePort  #ä¿®æ”¹
```

æµè§ˆå™¨æ‰“å¼€ http://10.199.10.231:30002/

## äº”ã€å…¶å®ƒå®‰è£…

### 5.1 å®‰è£…helm3

https://github.com/helm/helm/releases

é€‰æ‹©å¯¹åº”çš„ç‰ˆæœ¬

```shell
wget https://get.helm.sh/helm-v3.9.0-linux-amd64.tar.gz
tar xf helm-v3.9.0-linux-amd64.tar.gz
mv linux-amd64/helm /usr/local/bin/helm
helm version
#helm repo add aliyun https://kubernetes.oss-cnhangzhou.aliyuncs.com/charts
helm repo add bitnami https://charts.bitnami.com/bitnami
helm repo add google https://charts.helm.sh/stable
helm repo update
```

### 5.2 å®‰è£…Ingress-nginx

https://github.com/kubernetes/ingress-nginx
https://kubernetes.github.io/ingress-nginx/deploy/

```shell
#1.helmå®‰è£…
helm upgrade --install ingress-nginx ingress-nginx \
  --repo https://kubernetes.github.io/ingress-nginx \
  --namespace ingress-nginx --create-namespace

#2.kubectlå®‰è£…
kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.2.0/deploy/static/provider/cloud/deploy.yaml

#å‡ºç°é”™è¯¯ Internal error occurred: failed calling webhook "validate.nginx.ingress.kubernetes.io": failed to call webhook: Post "https://ingress-nginx-controller-admission.ingress-nginx.svc:443/networking/v1/ingresses?timeout=10s": context deadline exceeded
kubectl delete -A ValidatingWebhookConfiguration ingress-nginx-admission
```

### 5.3 éƒ¨ç½²nfs-provisionerä¸ºk8sé›†ç¾¤æä¾›åç«¯å­˜å‚¨

å®˜æ–¹githubåœ°å€ï¼šhttps://github.com/kubernetes-sigs/nfs-subdir-external-provisioner

#### 1.å‡†å¤‡nfsæœåŠ¡å™¨

```shell
#åˆ›å»ºnfsæ•°æ®ç›®å½•
mkdir /nfs
#å®‰è£…nfså·¥å…·
yum install nfs-utils -y
#ä¿®æ”¹é…ç½®æ–‡ä»¶
cat /etc/exports
/nfs *(rwï¼Œasync,no_all_squash)
#é‡å¯æœåŠ¡
systemctl enable --now nfs-server
#éªŒè¯nfsæœåŠ¡
showmount -e 127.0.0.1

Export list for 127.0.0.1:
/nfs *
```

#### 2.åœ¨k8séƒ¨ç½²nfs-provisioner

```shell
git clone https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner.git
cd nfs-subdir-external-provisioner/deploy
vi deployment.yaml
#ä¿®æ”¹IPå’ŒPATH
- name: NFS_SERVER
  value: 10.199.10.231
- name: NFS_PATH
  value: /nfs

- name: nfs-client-root
  nfs:
    server: 10.199.10.231
    path: /nsf

#ä¿®æ”¹å…è®¸å¤šä¸ªå‰¯æœ¬
spec:
  replicas: 3 #é«˜å¯ç”¨ï¼Œé…ç½®ä¸º3ä¸ªå‰¯æœ¬
env:
  - name: ENABLE_LEADER_ELECTION  #è®¾ç½®é«˜å¯ç”¨å…è®¸é€‰ä¸¾
    value: "True"

vi class.yaml
#æ–°å¢classå‚æ•°
parameters:
  archiveOnDelete: "false"
  pathPattern: "${.PVC.namespace}/${.PVC.annotations.nfs.io/storage-path}"

kubectl apply -f rbac.yaml
kubectl apply -f class.yaml
kubectl apply -f deployment.yaml

#éªŒè¯
kubectl get sc

NAME         PROVISIONER                                   RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE
nfs-client   k8s-sigs.io/nfs-subdir-external-provisioner   Delete          Immediate           false                  53s
```

## å…­ è¡¥å……å†…å®¹

kubectl taint nodes master01 node-role.kubernetes.io/master=:NoSchedule

### 6.1 é…ç½®ç™»å½•harbor

```shell
#docker
cat /etc/docker/daemon.json
{
   "exec-opts": ["native.cgroupdriver=systemd"],
   "insecure-registries": ["10.199.10.237","harbor"]
}
systemctl daemon-reload
systemctl restart docker
#containerd
vi /etc/containerd/config.toml
#å¢åŠ åé¢
[plugins."io.containerd.grpc.v1.cri".registry.configs]
        [plugins."io.containerd.grpc.v1.cri".registry.configs."10.199.10.237".tls]
          insecure_skip_verify = true
        [plugins."io.containerd.grpc.v1.cri".registry.configs."10.199.10.237".auth]
           username = "admin"
           password = "Harbor12345"

systemctl daemon-reload
systemctl restart containerd
```
